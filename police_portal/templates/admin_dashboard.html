{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<h1 class="text-center">Admin Dashboard</h1>
<p class="text-center">Hello, {{ user.username }} (Superuser)</p>

<h2>All Incidents</h2>
<table class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Incident ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Severity</th>
            <th>Status</th>
            <th>Created By</th>
            <th>Date Occurred</th>
            <th>Assessors</th>
        </tr>
    </thead>
    <tbody>
        {% for incident in incidents %}
        <tr>
            <td>{{ incident.incident_id }}</td>
            <td>{{ incident.title }}</td>
            <td>{{ incident.description }}</td>
            <td>{{ incident.severity }}</td>
            <td>{{ incident.status }}</td>
            <td>{{ incident.user.username }}</td>
            <td>{{ incident.date_occurred }}</td>
            <td>
                {% for assessor in incident.assessors.all %}
                    {{ assessor.username }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="8" class="text-center">No incidents found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>All Reports</h2>
<table class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Report ID</th>
            <th>Incident</th>
            <th>Report Type</th>
            <th>Generated By</th>
            <th>Created At</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for report in reports %}
        <tr>
            <td>{{ report.report_id }}</td>
            <td>{{ report.incident.title }}</td>
            <td>{{ report.report_type }}</td>
            <td>{{ report.generated_by.username }}</td>
            <td>{{ report.created_at }}</td>
            <td>
                <a href="{{ report.file_path.url }}" class="btn btn-primary btn-sm" download>Download</a>
                <a href="{% url 'view_report' report.report_id %}" class="btn btn-secondary btn-sm" target="_blank">View</a>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center">No reports found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>All Messages</h2>
<table class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Message ID</th>
            <th>Incident</th>
            <th>Sender</th>
            <th>Content</th>
            <th>Timestamp</th>
        </tr>
    </thead>
    <tbody>
        {% for message in messages_list %}
        <tr>
            <td>{{ message.message_id }}</td>
            <td>{{ message.incident.title }}</td>
            <td>{{ message.sender.username }}</td>
            <td>{{ message.content }}</td>
            <td>{{ message.timestamp }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" class="text-center">No messages found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>All Users</h2>
<table class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>User ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Created At</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr>
            <td>{{ user.id }}</td>
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.role }}</td>
            <td>{{ user.created_at }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" class="text-center">No users found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Join Requests</h2>
<table class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Request ID</th>
            <th>Incident Title</th>
            <th>Requested By</th>
            <th>Message</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for request in join_requests %}
        <tr>
            <td>{{ request.request_id }}</td>
            <td>{{ request.incident.title }}</td>
            <td>{{ request.requested_by.username }}</td>
            <td>{{ request.message }}</td>
            <td>{{ request.status }}</td>
            <td>
                {% if request.status == "Pending" %}
                <form method="POST" action="{% url 'handle_join_request' request.request_id %}">
                    {% csrf_token %}
                    <button type="submit" name="action" value="accept" class="btn btn-success btn-sm">Accept</button>
                    <button type="submit" name="action" value="decline" class="btn btn-danger btn-sm">Reject</button>
                </form>
                {% else %}
                <span class="text-muted">No actions available</span>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center">No join requests found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
